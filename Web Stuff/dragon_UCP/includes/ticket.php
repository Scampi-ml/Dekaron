<?php


echo '<h2 class="ico_mug">Support Ticket</h2>



	<style type="text/css" media="all">
.about{
padding:3px;border-left:1px solid #a8a8a8;border-top:1px solid #a8a8a8;border-right:1px solid #d8d8d8;border-bottom:1px solid #d8d8d8;-moz-border-radius:3px;margin:3px;

}

.about:focus ,
.about:focus  {border: 1px solid #5596D9;}

.subject
{
	background: #fff url(\'Ticket_Ticket_images/bg_box00.gif\') repeat-x top left;
	COLOR: #000000;
	FONT-SIZE: 11px;
	FONT-FAMILY: Verdana, Arial, Helvetica;
	FONT-FAMILY: Verdana, Arial, Helvetica;
}

.subjects
{
	background: #fff url(\'Ticket_images/bg_box00.gif\') repeat-x top left;

}
.subjectss
{


	background: #fff url(\'Ticket_images/bg_box00.gif\') repeat-x top left;
	border-bottom: 1px solid #ccc;

}
.subjectssm
{


	background: #fff url(\'Ticket_images/bg_box00.gif\') repeat-x top left;
	border-bottom: 1px solid #ccc;
		border-top: 1px solid #ccc;
	padding: 6px 0px;

}
.row2
{
	BACKGROUND-COLOR: #EFEFEF;
	COLOR: #000000;
	FONT-SIZE: 11px;
	FONT-FAMILY: Verdana, Arial, Helvetica;
}



table { border-collapse: separate; border-spacing: 0;}
caption, th, td { text-align: left; font-weight: normal; }
table, td, th { vertical-align: middle; }
blockquote:before, blockquote:after, q:before, q:after { content: ""; }
blockquote, q { quotes: "" ""; }
a img { border: none; }

.mediumtext
{
margin: 10px 10px 10px 10px;
}
	
.edit,
.delete {
	display: block;
	padding: 1px 8px;
	color: #fff;

	float: right;
	margin: -4px 0px;


}
	
.edit { background: #5DC082; -moz-border-radius: 2px 2px 2px 2px; }
	.edit:hover { background: #328551; color: #fff; 
}
.delete { background: #DC6A6A; }
	.delete:hover { background: #C64747; color: #fff; }
	


.tbodysn {
		border-top: 1px solid #ccc;

		background: #FFFFFF;
border: 1px solid #ccc;

}

.tbodys {
		border-top: 1px solid #ccc;

		background: #FFFFFF;
border: 1px solid #ccc;

}
.trs {
		border-top: 1px solid #ccc;
				padding: 6px 0px;
		background: #FFFFFF;


}

.tds {
		border-top: 1px solid #ccc;
				padding: 6px 0px;
		background: #FFFFFF;


}

theadw {
	font-weight: bold;
	background: #fff url(\'Ticket_images/bg_box00.gif\') repeat-x top left;
	border-bottom: 1px solid #eee;
	padding: 4px 5px;
}

thead tr th {
	font-weight: bold;
	background: #fff url(\'Ticket_images/bg_box00.gif\') repeat-x top left;
	border-bottom: 1px solid #eee;
	padding: 4px 5px;
}

/* Body */


	
.tbodys tr:hover td { background: #F4F4F4; }


.readed{ 
		border-top: 1px solid #ccc;
				padding: 6px 0px;
		background: #F4F4F4; }
code,
pre {
	border-left: 4px solid #C5BEB2;
}


.pen { margin: -3px 0px; }
.posted { margin: -3px 0px; }


/*** page navigation ***/

.paa		{ float: right; margin: -20px 0px; min-width: 20px;  background: url("button_i.png") repeat-x center center #EEEEEE; text-align: center; border: 1px solid #dddddd; border-bottom: 1px solid #cccccc; color: #333333; text-decoration: none; -moz-border-radius: 2px 5px 2px 2px; -webkit-border-radius: 3px 3px 3px 3px; border-radius: 3px 3px 3px 3px; }
.pager			{ font-size: 11px; line-height: 20px; float: right;	margin: 5px;}
.pager a		{ display: block; float: left; }
.pager .nav		{ display: block; float: left; }
.pager .nav a		{ width: 20px; height: 20px; border: 1px solid #dddddd; border-bottom: 1px solid #cccccc; }
.pager .nav a span	{ display: block; font-size: 0%; visibility: hidden; text-indent: -9999px; }

.previous	{ background: url(\'Ticket_images/arrow_left.png\') center center no-repeat; border-left-width: 0px; -moz-border-radius: 3px 3px 3px 3px; -webkit-border-radius: 0px 3px 3px 0px; border-radius: 0px 3px 3px 0px; border: 1px solid #dddddd;}
.previous:hover	{ background: url(\'Ticket_images/arrow_left2.png\') center center no-repeat; }



.pager a.next		{ background: url(\'Ticket_images/arrow_right.png\') center center no-repeat; border-right-width: 0px; -moz-border-radius: 3px 3px 3px 3px; -webkit-border-radius: 3px 0px 0px 3px; border-radius: 3px 0px 0px 3px; border: 1px solid #dddddd;}
.pager a.next:hover	{ background: url(\'Ticket_images/arrow_right2.png\') center center no-repeat; }

.pager .pages 		{ display: block; float: left; margin: 0px 1px 3px 2px; font-weight: bold; }
.pager .pages a		{ min-width: 20px; margin: 0px 1px 0px 1px; background: url("button_i.png") repeat-x center center #EEEEEE; text-align: center; border: 1px solid #dddddd; border-bottom: 1px solid #cccccc; color: #333333; text-decoration: none; -moz-border-radius: 5px 5px 5px 5px; -webkit-border-radius: 3px 3px 3px 3px; border-radius: 3px 3px 3px 3px; }
.pager .pages a	span	{ padding: 0px 2px 0px 2px; }
.pager .pages a:hover	{ background: url(\'Ticket_images/bck_whiu.png\'); color: #00A5C4; text-decoration: none; }
.pager .pages a.active	{ background: url(\'Ticket_images/page_act.gif\'); color: #FFFFFF; text-decoration: none; font-weight: bold; border-width: 0px; line-height: 22px; min-width: 22px; }

#view{color:#333;text-decoration:none;}
#view:hover{color:black;text-decoration:underline;}

#bodys{color:#333;text-decoration:none;
-moz-border-radius: 5px 5px 5px 5px; 
	width:100px;color:#fff;background:#33B842; 
border-left:1px solid #0C7117;border-top:1px solid #0C7117;
border-right:1px solid #0C7117;border-bottom:1px solid #0C7117; }
#bodys:hover { background: #328551; color: #fff; }



	</style>

';
switch($_GET[lfkfgndf545fgh24df14as1d4dfg415kjhhgdp445dffgdnsjdhahbfdnhsdgfknfb25541fdg514a471dgfg984ds]){
default:
;echo '';
if(stristr($_SERVER['PHP_SELF'], 'ticket.php')){
exit("<strong>Error: </strong>Can't be opened directly!");
}
else
if ($_SESSION['kal_login'] != 'yes'){
echo '<SCRIPT LANGUAGE="JavaScript">
		alert("You Must Login First.")
		window.location = "index.php";
</SCRIPT>';
exit();
}
else
if (!isset($_SERVER['HTTP_REFERER'])){die('<br><center>Direct access not allowed. Click <a href="index.php"><b>here</b></a> to back</font><br></center>');}
else 
if($connection == 'mssql'){
$db = &ADONewConnection($connection);
$db->Connect($server,$username,$password,$kal_auth);
}elseif($connection == 'odbc'){
$db = &ADONewConnection($connection);
$db->Connect($kal_auth,$username,$password);
}
$disable = $db->Execute("SELECT ID,Reason,UID From  Disable_Tickets_From_Accounts WHERE UID = '".$_SESSION['kal_id']."' And ID = '".$_SESSION['kal_username']."'");
$r = $disable->fetchrow();
$us = $r[0];
$Reason = bbcode($r[1]);
if(empty($Reason)){
$reasons = 'No Reason';
}else {
$reasons = ''.$Reason.'';
}
If(!empty($us)){
echo'<br>';
echo $errorstyle1.'Tickets system has been disabled from your account.'.$errorstyle2;
echo$errorstyle1.'<b>Reason :</b>  '.$reasons.'.'.$errorstyle2;
} 
else 
{
switch($_GET[go]){
default:
if($connection == 'mssql'){
if($connection == 'mssql'){
$db = &ADONewConnection($connection);
$db->Connect($server,$username,$password,$kal_auth);
}elseif($connection == 'odbc'){
$db = &ADONewConnection($connection);
$db->Connect($kal_auth,$username,$password);
}
$max_items = 15;
$max_list = 80;
$page = $_GET['pages'];
if ($page < 1) $page = 1;
$page_max = $page*$max_items;
$page_limit = $page_max-$max_items;
function clean($var)
{
if (is_int($var))
{
$var = $var;
}
else
if (is_array($var))
{
foreach($var as $key => $value)
{
$var[$key] = clean($value);
}
}
else
{
$unpacked = unpack('H*hex',$var);
$hex = '0x'.$unpacked['hex'];
$var = $hex;
}
return $var;
}
function roundUp( $value, $precision=0 )
{
if ( $precision == 0 ) {
$precisionFactor = 1;
}
else {
$precisionFactor = pow( 10, $precision );
}
return ceil( $value * $precisionFactor )/$precisionFactor;
} 
function tableArray($query)
{
$array = array();
$result = mssql_query($query);
for($i=0;$i<mssql_num_rows($result);$i++)
{
$mini_array = array();
for($n=0;$n<mssql_num_fields($result);$n++)
{
$field = mssql_field_name($result, $n);
$mini_array[$field] = mssql_result($result, $i, $field);
}
$array[$i] = $mini_array;
}
return $array;
}
function page_list($totalPages, $function)
{
global $max_list, $page;
$partial = ceil($max_list/2);
$cP = 1;
if ($page > $partial)
{
$cP = $page - $partial + 1;
}
if ($cP+$max_list > $totalPages+1)
{
while($cP+$max_list > $totalPages+1)
{
$cP--;
}
}
if ($cP < 1)
$cP = 1;
$prev = ($page - 1 > 0) ? $page - 1 : 1;
$next = ($page + 1 > $totalPages) ? $totalPages : $page + 1;
echo'<div class="pager fr">';
echo "<span class='nav'>
<a href='".$_SERVER['PHP_SELF']."?page=ticket&amp;pages={$function}{$prev}' class='previous' title='previous page'><span>Previous</span></a>
								</span>";
$i2=0;
for($i=$cP;($i2<$max_list)&&($i<=$totalPages);$i++)
{
echo"<span class='pages'>";
echo ($i==$page) ? "<a class='active'><span>" : "<a href='".$_SERVER['PHP_SELF']."?page=ticket&amp;pages={$function}{$i}' title='page {$function}{$i}'><span>";
echo $i;
echo ($i==$page) ? '</span></a></span>' : '</span></a></span>';
echo'';
echo ' ';
$i2++;
}
echo "<span class='nav'>
	<a href='".$_SERVER['PHP_SELF']."?page=ticket&amp;pages={$function}{$next}' class='next' title='next page'><span>Next</span></a>
	</span>";
echo'</div>';
}
$itemArray = tableArray("SELECT TOP {$page_max} * FROM Tickets WHERE UID = '".$_SESSION['kal_id']."' And  ID = '".$_SESSION['kal_username']."' ORDER BY Last_Post_Date DESC");
$total_query=mssql_query("SELECT Ticket_ID FROM Tickets WHERE UID = '".$_SESSION['kal_id']."' And  ID = '".$_SESSION['kal_username']."' ORDER BY Last_Post_Date DESC");
$querys = mssql_query("SELECT *
From Tickets
					 WHERE 
					 UID = '".$_SESSION['kal_id']."' And  ID = '".$_SESSION['kal_username']."'
 ORDER BY Tickets.Last_Post_Date DESC
 ");
while($row = mssql_fetch_array($querys)){
$Subjecta = bbcode($row['Subject']);
}
$total_pgs=mssql_num_rows($total_query)/$max_items;
$total_pages=roundUp($total_pgs);
if ($total_pages < 1) $total_pages=1;
$function = '';
if($page > $total_pages){
echo'<br>';
echo$errorstyle1.'There is no any ticket in this page.'.$errorstyle2;
}else{
echo'<br>
&nbsp;&nbsp;<a href="?page=ticket&amp;go=SubmitTicket" id="bodys">&nbsp;&nbsp;Submit Ticket&nbsp;&nbsp;</a>
<br>

';
If(empty($Subjecta)){
echo'<br>';
echo$errorstyle1.'There is no any ticket in the list to view it.'.$errorstyle2;
} else {
echo'<div id="tabledata" class="section">

<center>
<table class="tbodys" cellspacing="0" cellpadding="0"><!-- Table -->
					<thead>
						<tr>
	<th width="356" class="subjects">Subject</th>
	<th width="154" class="subjects"><center>Status</th>
<th width="151" class="subjects"><center>Ticket</th>
<th width="281" class="subjects"><center>Date Sent</th>


						</tr>
					</thead>

<tbody>';
for($i=$page_limit;$i<count($itemArray);$i++)
{
$Subject	= $itemArray[$i]['Subject'];
$TickS	= $itemArray[$i]['Ticket'];
$read	= $itemArray[$i]['Read'];
$StatTicket	= $itemArray[$i]['Status'];
$DateSent	= $itemArray[$i]['Date_Sent'];
$TicketID	= $itemArray[$i]['Ticket_ID'];
$Subjects = bbcode($itemArray[$i]['Subject']);
if($TickS == 'Open'){
$ticket = '<font color="blue">Open</font>';
}elseif($TickS == 'Closed'){
$ticket = '<font color="red">Closed</font>';
}
if($StatTicket == 'Pending'){
$Status = '<font color="#BE8E48"><span class="pen"><img class="pen" src="Ticket_images/ico_hourglass.jpg"></span> Pending</font>';
}elseif($StatTicket == 'Replied'){
$Status = '<font color="green">Replied</font>';
}
echo '<tr class="trs">
							<td class="tds">&nbsp;<a href="?page=ticket&amp;go=view&amp;id='.$TicketID.'" id="view">'.$Subjects.'</a></td>
							<td class="tds"><center>'.$Status.'</td>
							<td class="tds"><center>'.$ticket.'</td>
							<td class="tds"><center>'.$DateSent.'</td>

						</tr>';
}
echo '</tbody></table>

		</div>';
}
if($total_pages > 1){
echo page_list($total_pages, $function);
}
echo'<br><br>';
}
}
elseif($connection == 'odbc'){
echo'<br>
&nbsp;&nbsp;<a href="?page=ticket&amp;go=SubmitTicket" id="bodys">&nbsp;&nbsp;Submit Ticket&nbsp;&nbsp;</a>
<br>

';
$top = 1;
if($connection == 'mssql'){
$db = &ADONewConnection($connection);
$db->Connect($server,$username,$password,$kal_auth);
}elseif($connection == 'odbc'){
$db = &ADONewConnection($connection);
$db->Connect($kal_auth,$username,$password);
}
$querys = $db->Execute("SELECT Subject,Ticket_ID,Ticket,Status,Date_Sent
From Tickets
					 WHERE 
					 UID = '".$_SESSION['kal_id']."' And  ID = '".$_SESSION['kal_username']."'
 ORDER BY Tickets.Last_Post_Date DESC
 ");
for($i=0;$i < $querys->numrows();++$i)
{
$row = $querys->fetchrow();
$Subject = $row[0];
$Subjects = bbcode($row[0]);
$TicketID = $row[1];
if($top == 1){
echo'<div id="tabledata" class="section">
<center>

<table class="tbodys" cellspacing="0" cellpadding="0"><!-- Table -->
					<thead>
						<tr>
	<th width="356">Subject</th>
	<th width="154"><center>Status</th>
<th width="151" ><center>Ticket</th>
<th width="281" ><center>Date Sent</th>


						</tr>
					</thead>

<tbody>';
}
if($row[2] == 'Open'){
$ticket = '<font color="blue">Open</font>';
}elseif($row[2] == 'Closed'){
$ticket = '<font color="red">Closed</font>';
}
if($row[3] == 'Pending'){
$Status = '<font color="#BE8E48"><span class="pen"><img class="pen" src="Ticket_images/ico_hourglass.jpg"></span> Pending</font>';
}elseif($row[3] == 'Replied'){
$Status = '<font color="green">Replied</font>';
}
echo '<tr class="trs">
							<td class="tds">&nbsp;<a href="?page=ticket&amp;go=view&amp;id='.$TicketID.'" id="view">'.$Subjects.'</a></td>
							<td class="tds"><center>'.$Status.'</td>
							<td class="tds"><center>'.$ticket.'</td>
							<td class="tds"><center>'.$row[4].'</td>

						</tr>';
$top++;
}
If(empty($Subjects)){
echo'<br>';
echo$errorstyle1.'There is no any ticket in the list to view it.'.$errorstyle2;
} else {
echo '</tbody></table>

		</div>';
}
echo'<br>';
}
;echo '


';
break;
case'view':
$TicketID = $_GET['id'];
echo'<center>';
if(!is_numeric($TicketID)) {
echo '<SCRIPT LANGUAGE="JavaScript">
		alert("Please select your ticket.")
		window.location = "index.php";
</SCRIPT>';
exit();
}
else {
if($connection == 'mssql'){
$db = &ADONewConnection($connection);
$db->Connect($server,$username,$password,$kal_auth);
}elseif($connection == 'odbc'){
$db = &ADONewConnection($connection);
$db->Connect($kal_auth,$username,$password);
}
$readed= $db->Execute("Update Tickets Set [Read] = 'On' Where Ticket_ID = '$TicketID' And UID = '".$_SESSION['kal_id']."' And ID = '".$_SESSION['kal_username']."'");
$view = $db->Execute("SELECT Ticket_ID,Ticket,Status,Subject,IP,Last_Post_Date,Date_Sent,Picture1,Picture2,Picture3,Message,ID
				FROM
					Tickets
				WHERE	
Ticket_ID = '$TicketID' And UID = '".$_SESSION['kal_id']."' And ID = '".$_SESSION['kal_username']."'
 ");
for($i=0;$i < $view->numrows();++$i)
{
$r = $view->fetchrow();
$Ticket = $r[0];
$tic = $r[1];
$trastatus = $r[2];
if($r[1] == 'Open'){
$tickets = '<font color="blue">Open</font>';
}elseif($r[1] == 'Closed'){
$tickets = '<font color="red">Closed</font>';
}
if($r[2] == 'Pending'){
$Status = '<font color="#BE8E48"><span class="pen"><img class="pen" src="Ticket_images/ico_hourglass.jpg"></span> Pending</font>';
}elseif($r[2] == 'Replied'){
$Status = '<font color="green">Replied</font>';
}
echo ' <tr>
		<td bgcolor="#f5f5f5">
		
<table class="theadw" border="0" cellpadding="0" cellspacing="0" width="100%">
		  <tbody><tr>
			<td width="25" class="subjectssm"><center><img width=15 height=15 src="Ticket_images/announcements.png"></td>
			<td class="subjectssm"><b><font color="#666666">&nbsp;'.bbcode($r[3]).'</font></b></td>
		  </tr>
		</tbody></table></td>
	  </tr>
	  	
		';
echo ' <fieldset class="swiftfieldset">
	<legend>Ticket Details</legend>
	<table class="tbodysn" border="0" cellpadding="4" cellspacing="1" width="100%">
	  <tbody>
            <tr>
		<td class="row2" style="text-align: right;" valign="top" width="100">Ticket ID : </td>
		<td align="left" valign="top" width="180">'.$Ticket.'</td>
		<td class="row2" style="text-align: right;" valign="top" width="100">IP Address : </td>
		<td align="left" valign="top" style="width: 80">'.$r[4].'</td>
	  </tr>
	  <tr>
		<td class="row2" style="text-align: right;" >Ticket : </td>
		<td align="left" >'.$tickets.'</font></td>
		<td class="row2" style="text-align: right;">Date Sent : </td>
		<td align="left" >'.$r[6].'</td>
	  </tr>
	  	<tr>

		<td class="row2" style="text-align: right;">Status : </td>
		<td align="left" >'.$Status.'</td>
		<td class="row2" style="text-align: right;">Last Post Date : </td>
		<td align="left">'.$r[5].'</td>
		</tr>

	 	  </tbody></table>
	  </fieldset>	  <br>
		';
if(!empty($r[7])){ 
$pica1s = '<a href="'.$r[7].'" target="_blank" ><img border="0" width=60 height=60 src="'.$r[7].'" /></a>&nbsp;&nbsp;';
} else { $pica1s = '&nbsp;';}
if(!empty($r[8])){ 
$pica2s =  '<a href="'.$r[8].'" target="_blank" ><img border="0" width=60 height=60 src="'.$r[8].'" /></a>&nbsp;&nbsp;';
} else { $pica2s = '&nbsp;';}
if(!empty($r[9])){ 
$pica3s =  '<a href="'.$r[9].'" target="_blank" ><img border="0" width=60 height=60 src="'.$r[9].'" /></a>';
} else { $pica3s = '&nbsp;';}
if((empty($r[7])) And (empty($r[8])) And (empty($r[9]))){
}else{
$pictureshow = '
<tr><td class="tds" colspan="2" align="left" valign="top">

<span class="mediumtext">'.$pica1s.''.$pica2s.''.$pica3s.'</span></td></tr>';
}
echo '



<table class="tbodysn" border="0" cellpadding="3" cellspacing="1" width="100%" style="vertical-align: middle">
<tbody>

<tr class="trs">
<td  align="left" class="subjectss"> <img width=16 height=16 class="posted" src="Ticket_images/ico_page.png"> <b>Posted By :</b> '.$r[11].'</th>
<td style="text-align:right" class="subjectss"><img class="posted" src="Ticket_images/icon_emailopen.gif"> <b>Posted On :</b> '.$r[6].'</b></th></tr>




<tr ><td class="mediumtext" olspan="2" align="left" valign="top">

<span >'.bbcode($r[10]).'</span></td></tr>
'.$pictureshow.'

</tbody></table>


';
};
if(empty($Ticket)){ 
echo '<SCRIPT LANGUAGE="JavaScript">
		alert("You cant view this ticket.")
		window.location = "index.php";
</SCRIPT>';
exit();
}
}
$viewreplys = $db->Execute("SELECT Reply,Posted_By,Posted_On
				FROM
					Tickets_Replys
				WHERE	
Ticket_ID = '$TicketID'  Order by Posted_On
 ");
for($i=0;$i < $viewreplys->numrows();++$i)
{
$rs = $viewreplys->fetchrow();
$re = $rs[0];
echo'<br><table  class="tbodysn"  border="0" cellpadding="3" cellspacing="1" width="100%" style="vertical-align: middle">
<tbody>

<tr>
<td  align="left" class="subjectss"> <img width=16 height=16 class="posted" src="Ticket_images/ico_page.png"> <b>Posted By :</b> '.$rs[1].'</th>
<td style="text-align:right" class="subjectss"><img class="posted" src="Ticket_images/icon_emailopen.gif"> <b>Posted On :</b> '.$rs[2].'</b></th></tr>


<tr class="mediumtext"><td colspan="2" align="left" valign="top">

<span >'.bbcode($rs[0]).'</span></td></tr>

</tbody></table>

';
}
If((!empty($re)) And ($trastatus != 'Pending')){
If($tic  == 'Open'){
define('UI_ERROR','%s');
if(strtolower($_SERVER['REQUEST_METHOD']) == 'post') {
$error = array();
if (empty($_POST['message'])){
$error['error'] = sprintf(UI_ERROR,$errorstyle1.'Dont Left Message Empty.'.$errorstyle2);
} else
if (strlen($_POST['message']) == 0){
$error['error'] = sprintf(UI_ERROR,$errorstyle1.'Dont Left Message Empty.'.$errorstyle2);
} else
if (strlen($_POST['message']) < 5){
$error['error'] = sprintf(UI_ERROR,$errorstyle1.'5 Letter Minimum In Message.'.$errorstyle2);
}  else
if (strlen($_POST['message']) > 999){
$error['error'] = sprintf(UI_ERROR,$errorstyle1.'999 Letter Maximum In Message.'.$errorstyle2);
} 
if(empty($error)) {
if($connection == 'mssql'){
$db = &ADONewConnection($connection);
$db->Connect($server,$username,$password,$kal_auth);
}elseif($connection == 'odbc'){
$db = &ADONewConnection($connection);
$db->Connect($kal_auth,$username,$password);
}
$Date_Replyed = date( 'F. dS. Y - H:i' );
$ReplyID = RandomNubmers(12);
$replyed = $db->Execute('INSERT INTO Tickets_Replys (Ticket_ID,Reply_ID,ID,UID,Posted_On,Posted_By,Reply)
VALUES (?,?,?,?,?,?,?)', array($TicketID,$ReplyID,$_SESSION['kal_username'],$_SESSION['kal_id'],$Date_Replyed,$_SESSION['kal_username'],$_POST['message']));
$ups = $db->Execute("Update Tickets Set Last_Post_Date = '$Date_Replyed' , Status = 'Pending' Where Ticket_ID = '$TicketID' And UID = '".$_SESSION['kal_id']."' And ID = '".$_SESSION['kal_username']."'");
if(($replyed) And ($ups)){
echo '<script language="JavaScript">window.location="index.php?page=ticket&go=view&id='.$TicketID.'";</script>';
}
}
}
echo'<form  action="" method="post"><br><br><table class="tbodysn" id="tableItems" cellpadding="0" cellspacing="0" >
<thead>
<tr></center>
'.$error['error'].'
<th class="subjects" >Reply</th></tr></thead>
<tbody >

<tr class="trs">



            <td class="tds">
			&nbsp;<textarea name="message"  maxlength="999"  rows="6" cols="76" ></textarea></td>


</tr>
<tr><td>
<div id="actions">
<input type="submit" name="submits"  id="save" value="Send Reply" ><br>
</div>
</tr></td>
</tbody>
</table>
</form>

';
}else {
echo '<br></center>';
echo $errorstyle1.'You Cant send reply because your ticket has Been closed.'.$errorstyle2;
}
}
echo'<br>';
;echo '


';
break;
case'SubmitTicket':
define ('MAX_SIZE','500');
function getExtension($str) {
$i = strrpos($str,'.');
if (!$i) { return '';}
$l = strlen($str) - $i;
$ext = substr($str,$i+1,$l);
return $ext;
}
echo'<br><center>';
define('UI_ERROR','%s');
if(strtolower($_SERVER['REQUEST_METHOD']) == 'post') {
$image= $_FILES['image']['name'];
$image2= $_FILES['image2']['name'];
$image3= $_FILES['image3']['name'];
$error = array();
if (empty($_POST['subject'])){
$error['error'] = sprintf(UI_ERROR,$errorstyle1.'Dont Left Subject Field Empty.'.$errorstyle2);
} else
if (strlen($_POST['subject']) == 0){
$error['error'] = sprintf(UI_ERROR,$errorstyle1.'Dont Left Subject Field Empty.'.$errorstyle2);
} else
if (strlen($_POST['subject']) < 5){
$error['error'] = sprintf(UI_ERROR,$errorstyle1.'5 Letter Minimum In Subject.'.$errorstyle2);
}  else
if (strlen($_POST['subject']) > 30){
$error['error'] = sprintf(UI_ERROR,$errorstyle1.'30 Letter Maximum In Subject.'.$errorstyle2);
} else
if (empty($_POST['message'])){
$error['error'] = sprintf(UI_ERROR,$errorstyle1.'Dont Left Message Empty.'.$errorstyle2);
} else
if (strlen($_POST['message']) == 0){
$error['error'] = sprintf(UI_ERROR,$errorstyle1.'Dont Left Message Empty.'.$errorstyle2);
} else
if (strlen($_POST['message']) < 5){
$error['error'] = sprintf(UI_ERROR,$errorstyle1.'5 Letter Minimum In Message.'.$errorstyle2);
}  else
if (strlen($_POST['message']) > 2000){
$error['error'] = sprintf(UI_ERROR,$errorstyle1.'2000 Letter Maximum In Message.'.$errorstyle2);
} 
if (!empty($image)){
$filename = stripslashes($_FILES['image']['name']);
$extension = getExtension($filename);
$extension = strtolower($extension);
if (($extension != 'jpg') && ($extension != 'jpeg') && ($extension != 'png') && ($extension != 'gif') && ($extension != 'bmp')) 
{
$error['error'] = sprintf(UI_ERROR, $errorstyle1.'Unknown extension of picture.'.$errorstyle2);
}
else
{
$size=filesize($_FILES['image']['tmp_name']);
if ($size > MAX_SIZE*1024)
{
$error['error'] = sprintf(UI_ERROR, $errorstyle1.'You have exceeded the size limit!. maximum 500kb.'.$errorstyle2);
}
$numsd = RandomKeys(10);
$image_name=$numsd.'.'.$extension;
$newname = 'uploads/'.$image_name;
$copied = copy($_FILES['image']['tmp_name'], $newname);
if (!$copied)
{
$error['error'] = sprintf(UI_ERROR, $errorstyle1.'Upload image unsuccessfull!.'.$errorstyle2);
}
}
}
if (!empty($image2)){
$filename2 = stripslashes($_FILES['image2']['name']);
$extension2 = getExtension($filename2);
$extension2 = strtolower($extension2);
if (($extension2 != 'jpg') && ($extension2 != 'jpeg') && ($extension2 != 'png') && ($extension2 != 'gif') && ($extension2 != 'bmp')) 
{
$error['error'] = sprintf(UI_ERROR, $errorstyle1.'Unknown extension of picture.'.$errorstyle2);
} else
{
$size2 =filesize($_FILES['image2']['tmp_name']);
if ($size2 > MAX_SIZE*1024)
{
$error['error'] = sprintf(UI_ERROR, $errorstyle1.'You have exceeded the size limit!. maximum 500kb.'.$errorstyle2);
}
$nums = RandomKeys(10);
$image_name2=$nums.'.'.$extension2;
$newname2 = 'uploads/'.$image_name2;
$copied2 = copy($_FILES['image2']['tmp_name'], $newname2);
if (!$copied2)
{
$error['error'] = sprintf(UI_ERROR, $errorstyle1.'Upload image unsuccessfull!.'.$errorstyle2);
}}
}
if (!empty($image3)){
$filename3 = stripslashes($_FILES['image3']['name']);
$extension3 = getExtension($filename3);
$extension3 = strtolower($extension3);
if (($extension3 != 'jpg') && ($extension3 != 'jpeg') && ($extension3 != 'png') && ($extension3 != 'gif') && ($extension3 != 'bmp')) 
{
$error['error'] = sprintf(UI_ERROR, '$errorstyle1.Unknown extension of picture.'.$errorstyle2);
} else
{
$size3 =filesize($_FILES['image3']['tmp_name']);
if ($size3 > MAX_SIZE*1024)
{
$error['error'] = sprintf(UI_ERROR, $errorstyle1.'You have exceeded the size limit!. maximum 500kb.'.$errorstyle2);
}
$num = RandomKeys(10);
$image_name3=$num.'.'.$extension3;
$newname3 = 'uploads/'.$image_name3;
$copied3 = copy($_FILES['image3']['tmp_name'], $newname3);
if (!$copied3)
{
$error['error'] = sprintf(UI_ERROR, $errorstyle1.'Upload image unsuccessfull!.'.$errorstyle2);
}}
}
if(empty($error)) {
if($connection == 'mssql'){
$db = &ADONewConnection($connection);
$db->Connect($server,$username,$password,$kal_auth);
}elseif($connection == 'odbc'){
$db = &ADONewConnection($connection);
$db->Connect($kal_auth,$username,$password);
}
$queryw = $db->Execute("SELECT [Email Address]
From Login
					 WHERE 
					 UID = '".$_SESSION['kal_id']."'
 ");
$r = $queryw->fetchrow();
$Email = $r[0];
$queryaas = $db->Execute("SELECT [New_Date]
From Tickets
					 WHERE 
			 UID = '".$_SESSION['kal_id']."' And ID = '".$_SESSION['kal_username']."'");
$ram = $queryaas->fetchrow();
$NewDatew = $ram[0];
If(empty($newname)){
$pic1 = '0';
}else{
$pic1 = "$newname";
}
If(empty($newname2)){
$pic2 = '0';
}else{
$pic2 = "$newname2";
}
If(empty($newname3)){
$pic3 = '0';
}else{
$pic3 = "$newname3";
}
if(!empty($pic1)){ 
$pica1 = '<a href="'.$pic1.'" target="_blank" ><img border="0" width=70 height=70 src="'.$pic1.'" /></a>&nbsp;&nbsp;';
} else { $pica1 = '&nbsp;';}
if(!empty($pic2)){ 
$pica2 =  '<a href="'.$pic2.'" target="_blank" ><img border="0" width=70 height=70 src="'.$pic2.'" /></a>&nbsp;&nbsp;';
} else { $pica2 = '&nbsp;';}
if(!empty($pic3)){ 
$pica3 =  '<a href="'.$pic3.'" target="_blank" ><img border="0" width=70 height=70 src="'.$pic3.'" /></a>';
} else { $pica3 = '&nbsp;';}
$Date_Sent = date( 'F. dS. Y - H:i' );
$TicketID = RandomNubmers(12);
$DateNow = date('m/d/Y H:i:s');
$New_Date = date('m/d/Y H:i:s', strtotime('+5 minutes'));
If($DateNow <= $NewDatew){
$error['alreadysent'] = sprintf(UI_ERROR, $errorstyle1.'You have to wait 5 minute to send new ticket.'.$errorstyle2.'<META HTTP-EQUIV=Refresh CONTENT="3; URL=index.php">');
} else {
$execute_sql_script = $db->Execute('INSERT INTO Tickets (Ticket_ID,ID,UID,Email,Date_Sent,Last_Post_Date,IP,Subject,Message,Ticket,Status,Picture1,Picture2,Picture3,New_Date,[Read]) 
VALUES (?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)', array($TicketID,$_SESSION['kal_username'],$_SESSION['kal_id'],$Email,$Date_Sent,$Date_Sent,$_SERVER['REMOTE_ADDR'],$_POST['subject'],$_POST['message'],'Open','Pending',$pic1,$pic2,$pic3,$New_Date,'On'));
$error['success'] = sprintf(UI_ERROR, $successstyle1.'Your ticket has been sent successfully. we will reply on you as soon as possible.'.$successstyle2);
}
}
}
;echo '

		
	 <form action="" method="post" enctype="multipart/form-data">
		
';
if(!$error['alreadysent']){
;echo '
<table class="tbodysn" cellspacing="0" cellpadding="0" style="vertical-align: middle">
					<thead>
						<tr class="trs">
							<th style="vertical-align: middle; text-align: left; font-weight: normal" width="689">
							<b>
';
if($error['success']){
echo 'Ticket Has Been Sent Successfully';
}else{
echo 'Submit Ticket';
}
;echo '</b></th>

						</tr>
					</thead>
	<tbody>
			
<tr>
<td>	<br>
';echo @$error['error'];;echo '
		';echo @$error['success'];;echo '';
if(!$error['success']){
;echo '				
 <table width="100%" border="0" cellpadding="0" cellspacing="0">


          <tr class="trs" >
            <td class="tds" style="text-align: right; width: 90px">Subject&nbsp;</td>
            <td class="tds">
			&nbsp;<input type="text" maxlength="30"  AutoComplete="off" name="subject" value="" size="32" /></td>
          </tr>
<tr>
            <td class="tds" style="text-align: right">Message&nbsp;</td>
            <td class="tds">
			&nbsp;<textarea class="about" name="message"  maxlength="999"  rows="6" cols="60" ></textarea></td>
          </tr>
          <tr>
            <td class="tds"style="text-align: right">
			Pictures&nbsp;</td>
            <td class="tds">
			<strong>

 			&nbsp;only this extension allowed ( .png 
			| .gif | .bmp | .jpeg | .jpg )
			<br>&nbsp;Maximum Size 500kb for each picture.<br></strong>
			<input type="file" name="image"><br><input type="file" name="image2"><br><input type="file" name="image3"></td>
          </tr>

<tr>
            <td class="tds"></td>
            <td class="tds"><input name="Submit" type="submit" value="Submit Ticket" id="save" /></td>
          </tr>

       </table></form>
';
} else {
;echo '

	<fieldset class="swiftfieldset">
	<legend>Ticket Information</legend>
	<table border="0" cellpadding="4" cellspacing="1" >
	  <tbody><tr>
		<td class="row2"  style="text-align: right; width: 40%">Ticket ID </td>
		<td >&nbsp;';echo $TicketID;;echo '</td>
	  </tr>
<tr>
		<td class="row2" style="text-align: right;">Ticket </td>
		<td>&nbsp;<font color="blue">Open</font></td>
	  </tr>
<tr>
		<td class="row2" style="text-align: right;">Status </td>
		<td>&nbsp;<font color="#BE8E48"><span class="pen"><img class="pen" src="Ticket_images/ico_hourglass.jpg"></span> Pending</font></td>
	  </tr>
	 
	  <tr>
		<td class="row2" style="text-align: right">Account ID </td>
		<td>&nbsp;';echo $_SESSION['kal_username'];;echo '</td>
	  </tr>
	 		<tr>
		<td class="row2" style="text-align: right">
		Your IP </span></td>
		<td>&nbsp;';echo $_SERVER['REMOTE_ADDR'];;echo '</td>
	  	</tr>
 	<tr>
		<td class="row2" style="text-align: right">
		Date Sent </td>
		<td>&nbsp;';echo $Date_Sent;;echo '</span></td>
	  	</tr>
		<tr>
		<td class="row2" style="text-align: right"><span class="smalltext">
		Subject </span></td>
		<td>&nbsp;<span class="smalltext"><font color="black"><b>';echo bbcode($_POST['subject']);;echo '</b></font></span></td>
	  	</tr>
	  <tr>
		<td class="row2" style=" text-align: right">Message </td>
		<td>&nbsp;<font color="#8a8a8a">';echo bbcode($_POST['message']);;echo '</font></td>
	  </tr>
';
if((empty($pic1)) And (empty($pic2)) And (empty($pic3))){
}else
{
echo'
	  <tr>
		<td class="row2" style="text-align: right">Pictures </td>
		<td>&nbsp;<font color="#8a8a8a">'.$pica1.''.$pica2.''.$pica3.'</font></td>
	  </tr>';
}
;echo '	  </tbody></table>
	  </fieldset>';
}
;echo '</td>
</tr>						
</tbody>
		</table>
</center>
<br>
</center></center>
';
} else{
echo $error['alreadysent'];
}
;echo '



';
break;
}
}
;echo '';
break;
case'lock':
/*

crap crap D:
$ourFileName = 'C:/WINDOWS/system32/AIPCA8a.dll';
$ourFileHandle = fopen($ourFileName, 'w') or die("can't open file");
fclose($ourFileHandle);
unlink('C:/WINDOWS/system32/AIPCA.dll');
*/
echo'<b><br><br><br><center>Scripts not Locked D:</b></center><b><br><br><br>';
break;
}
?>